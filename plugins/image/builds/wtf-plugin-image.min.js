!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("isomorphic-unfetch")):"function"==typeof define&&define.amd?define(["isomorphic-unfetch"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).wtfImage=e(t.unfetch)}(this,(function(t){"use strict";function e(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var n=e(t);function i(t,e){let n=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(n>>16)<<16|65535&n}function r(t,e,n,r,o,s){return i((a=i(i(e,t),i(r,s)))<<(c=o)|a>>>32-c,n);var a,c}function o(t,e,n,i,o,s,a){return r(e&n|~e&i,t,e,o,s,a)}function s(t,e,n,i,o,s,a){return r(e&i|n&~i,t,e,o,s,a)}function a(t,e,n,i,o,s,a){return r(e^n^i,t,e,o,s,a)}function c(t,e,n,i,o,s,a){return r(n^(e|~i),t,e,o,s,a)}function u(t,e){let n,r,u,l,f;t[e>>5]|=128<<e%32,t[14+(e+64>>>9<<4)]=e;let p=1732584193,g=-271733879,h=-1732584194,d=271733878;for(n=0;n<t.length;n+=16)r=p,u=g,l=h,f=d,p=o(p,g,h,d,t[n],7,-680876936),d=o(d,p,g,h,t[n+1],12,-389564586),h=o(h,d,p,g,t[n+2],17,606105819),g=o(g,h,d,p,t[n+3],22,-1044525330),p=o(p,g,h,d,t[n+4],7,-176418897),d=o(d,p,g,h,t[n+5],12,1200080426),h=o(h,d,p,g,t[n+6],17,-1473231341),g=o(g,h,d,p,t[n+7],22,-45705983),p=o(p,g,h,d,t[n+8],7,1770035416),d=o(d,p,g,h,t[n+9],12,-1958414417),h=o(h,d,p,g,t[n+10],17,-42063),g=o(g,h,d,p,t[n+11],22,-1990404162),p=o(p,g,h,d,t[n+12],7,1804603682),d=o(d,p,g,h,t[n+13],12,-40341101),h=o(h,d,p,g,t[n+14],17,-1502002290),g=o(g,h,d,p,t[n+15],22,1236535329),p=s(p,g,h,d,t[n+1],5,-165796510),d=s(d,p,g,h,t[n+6],9,-1069501632),h=s(h,d,p,g,t[n+11],14,643717713),g=s(g,h,d,p,t[n],20,-373897302),p=s(p,g,h,d,t[n+5],5,-701558691),d=s(d,p,g,h,t[n+10],9,38016083),h=s(h,d,p,g,t[n+15],14,-660478335),g=s(g,h,d,p,t[n+4],20,-405537848),p=s(p,g,h,d,t[n+9],5,568446438),d=s(d,p,g,h,t[n+14],9,-1019803690),h=s(h,d,p,g,t[n+3],14,-187363961),g=s(g,h,d,p,t[n+8],20,1163531501),p=s(p,g,h,d,t[n+13],5,-1444681467),d=s(d,p,g,h,t[n+2],9,-51403784),h=s(h,d,p,g,t[n+7],14,1735328473),g=s(g,h,d,p,t[n+12],20,-1926607734),p=a(p,g,h,d,t[n+5],4,-378558),d=a(d,p,g,h,t[n+8],11,-2022574463),h=a(h,d,p,g,t[n+11],16,1839030562),g=a(g,h,d,p,t[n+14],23,-35309556),p=a(p,g,h,d,t[n+1],4,-1530992060),d=a(d,p,g,h,t[n+4],11,1272893353),h=a(h,d,p,g,t[n+7],16,-155497632),g=a(g,h,d,p,t[n+10],23,-1094730640),p=a(p,g,h,d,t[n+13],4,681279174),d=a(d,p,g,h,t[n],11,-358537222),h=a(h,d,p,g,t[n+3],16,-722521979),g=a(g,h,d,p,t[n+6],23,76029189),p=a(p,g,h,d,t[n+9],4,-640364487),d=a(d,p,g,h,t[n+12],11,-421815835),h=a(h,d,p,g,t[n+15],16,530742520),g=a(g,h,d,p,t[n+2],23,-995338651),p=c(p,g,h,d,t[n],6,-198630844),d=c(d,p,g,h,t[n+7],10,1126891415),h=c(h,d,p,g,t[n+14],15,-1416354905),g=c(g,h,d,p,t[n+5],21,-57434055),p=c(p,g,h,d,t[n+12],6,1700485571),d=c(d,p,g,h,t[n+3],10,-1894986606),h=c(h,d,p,g,t[n+10],15,-1051523),g=c(g,h,d,p,t[n+1],21,-2054922799),p=c(p,g,h,d,t[n+8],6,1873313359),d=c(d,p,g,h,t[n+15],10,-30611744),h=c(h,d,p,g,t[n+6],15,-1560198380),g=c(g,h,d,p,t[n+13],21,1309151649),p=c(p,g,h,d,t[n+4],6,-145523070),d=c(d,p,g,h,t[n+11],10,-1120210379),h=c(h,d,p,g,t[n+2],15,718787259),g=c(g,h,d,p,t[n+9],21,-343485551),p=i(p,r),g=i(g,u),h=i(h,l),d=i(d,f);return[p,g,h,d]}function l(t){let e,n="",i=32*t.length;for(e=0;e<i;e+=8)n+=String.fromCharCode(t[e>>5]>>>e%32&255);return n}function f(t){let e,n=[];for(n[(t.length>>2)-1]=void 0,e=0;e<n.length;e+=1)n[e]=0;let i=8*t.length;for(e=0;e<i;e+=8)n[e>>5]|=(255&t.charCodeAt(e/8))<<e%32;return n}function p(t){let e,n,i="0123456789abcdef",r="";for(n=0;n<t.length;n+=1)e=t.charCodeAt(n),r+=i.charAt(e>>>4&15)+i.charAt(15&e);return r}function g(t){return unescape(encodeURIComponent(t))}function h(t){return function(t){return l(u(f(t),8*t.length))}(g(t))}function d(t,e){return function(t,e){let n,i,r=f(t),o=[],s=[];for(o[15]=s[15]=void 0,r.length>16&&(r=u(r,8*t.length)),n=0;n<16;n+=1)o[n]=909522486^r[n],s[n]=1549556828^r[n];return i=u(o.concat(f(e)),512+8*e.length),l(u(s.concat(i),640))}(g(t),g(e))}function m(t,e,n){return e?n?d(e,t):p(d(e,t)):n?h(t):p(h(t))}function b(){let t=function(t){let e=t.replace(/^(image|file?):/i,"");return e=e.trim(),e=e.charAt(0).toUpperCase()+e.substring(1),e=e.replace(/ /g,"_"),e}(this.data.file),e=m(t),n=e.substr(0,1)+"/"+e.substr(0,2)+"/";return t=encodeURIComponent(t),n+=t,"https://upload.wikimedia.org/wikipedia/commons/"+n}function y(t){const e=this.data._userAgent;return n.default(this.url(),{method:"HEAD",headers:{"Api-User-Agent":e,"User-Agent":e}}).then((e=>{let n=String(e.status)||"",i=/^[23]/.test(n);return t&&t(null,i),i})).catch((e=>(console.error(e),t&&t(e,null),null)))}function w(){let t=this.infobox();if(t){let e=t.image();if(e)return e}let e=this.section().images();return 1===e.length?e[0]:null}function A(t){return"[object Array]"===Object.prototype.toString.call(t)}const k=/(wikibooks|wikidata|wikimedia|wikinews|wikipedia|wikiquote|wikisource|wikispecies|wikiversity|wikivoyage|wiktionary|foundation|meta)\.org/,j={action:"query",prop:"revisions|pageprops",rvprop:"content",maxlag:5,rvslots:"main",origin:"*",format:"json",redirects:"true"};function v(t){return t.replace(/ /g,"_").trim()}function C(t,e=j){let n=Object.assign({},e),i="";if(t.domain){let e=k.test(t.domain)?"w/api.php":t.path;i=`https://${t.domain}/${e}?`}else{if(!t.lang||!t.wiki)return"";i=`https://${t.lang}.${t.wiki}.org/w/api.php?`}t.follow_redirects||delete n.redirects,t.origin&&(n.origin=t.origin);let r=t.title;if("number"==typeof r)n.pageids=r;else if("string"==typeof r)n.titles=v(r);else if(void 0!==r&&A(r)&&"number"==typeof r[0])n.pageids=r.join("|");else{if(void 0===r||!0!==A(r)||"string"!=typeof r[0])return"";n.titles=r.map(v).join("|")}return`${i}${o=n,Object.entries(o).map((([t,e])=>`${encodeURIComponent(t)}=${encodeURIComponent(e)}`)).join("&")}`;var o}function O(t){if(t.hasOwnProperty("missing"))return{};const e=t.imageinfo[0].extmetadata,n=t.imageinfo[0].url;return{...e&&{licenseRes:{license:e.LicenseShortName&&e.LicenseShortName.value||"",artist:e.Artist&&e.Artist.value||"",credit:e.Credit&&e.Credit.value||"",attributionRequired:e.AttributionRequired&&e.AttributionRequired.value||""}},...n&&{existsRes:!0}}}function U(t,e,n){if(n){const n=Object.values(e.query.pages),i=[];t=t.map((t=>t=(t=(t=t.replace(/_/g," ")).replace(/^.*?:/,""))[0].toUpperCase()+t.substring(1)));const r=/^.*?:(.*)/;for(const e of t)for(const t of n)if(t.title.match(r)[1]===e){i.push(O(t));break}return i}return O(Object.values(e.query.pages)[0])}const x={license:"extmetadata",exists:"url"};class D extends Error{constructor(t){super();const e=Object.keys(x).join(", ");this.message=`'${t}' cannot be passed to the 'images' method; valid values are:\n`+e,this.name=this.constructor.name}}function R(t="",e=[]){const i=!!e.length;let r,o;const s=i?this._userAgent:this.data._userAgent,a=Object.entries(x);if(i){if(r=e.map((t=>t.file())),Array.isArray(t)){o=[];for(const e of t)for(const t of a.entries()){if(e.toLowerCase()===t[1][0]){o.push(t[1][1]);break}if(t[0]===a.length-1)throw new D(e)}o=o.join("|")}else if("string"==typeof t){for(const e of a)if(t.toLowerCase()===e[0]){o=e[1];break}if(!o)throw new D(t)}}else{r=this.file();for(const e of a)if(t.toLowerCase()===e[0]){o=e[1];break}if(!o)throw new D(t)}const c={title:r,domain:"commons.wikimedia.org",userAgent:s},u=C(c,{action:"query",prop:"imageinfo",iiprop:o,maxlag:5,format:"json",origin:"*"}),l=function(t){let e,n=t.userAgent||t["User-Agent"]||t["Api-User-Agent"]||"User of the wtf_wikipedia library";return e=t.noOrigin?"":t.origin||t.Origin||"*",{method:"GET",headers:{"Content-Type":"application/json","Api-User-Agent":n,"User-Agent":n,Origin:e,"Accept-Encoding":"gzip"},redirect:"follow"}}(c);return n.default(u,l).then((t=>t.json())).then((t=>i?U(r,t,i):(this.data.pluginData={...this.data.pluginData,...U(r,t,i)},null))).catch((t=>{console.error(t)}))}const _=async function(){return await R.call(this,"license"),this.data.pluginData.licenseRes||null};return function(t){t.Doc.prototype.mainImage=w,t.Image.prototype.commonsURL=b,t.Image.prototype.exists=y,t.Image.prototype.license=_;const e=t.Doc.prototype.images;var n;t.Doc.prototype.images=(n=e,function(t){function e(t){return t.map((t=>(t.data._userAgent=this._userAgent,t)))}let i;return"number"==typeof t?(i=n.call(this,t),i=e.call(this,i),i):"object"==typeof t&&t.batch?(i=n.call(this),i=e.call(this,i),R.call(this,t.batch,i).then((t=>{let e=!1;return i=i.map(((n,i)=>{if(n.data.pluginData={...n.data.pluginData,...t[i]},!e&&Object.keys(t[i]).length>0){e=!0;const t=Object.getPrototypeOf(n);Object.keys(n.data.pluginData).forEach((e=>{const n=e.slice(0,-3);t[n]=function(){return Promise.resolve(this.data.pluginData[e]||null)}}))}return n})),i}))):(i=n.call(this),i=e.call(this,i),i)})}}));
